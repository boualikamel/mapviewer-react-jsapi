(this["webpackJsonptesting-ant-cra"]=this["webpackJsonptesting-ant-cra"]||[]).push([[26],{1027:function(e,t,r){"use strict";r.r(t),r.d(t,"constructAssociationMetaDataFeatureSetFromUrl",(function(){return re})),r.d(t,"constructFeatureSet",(function(){return ee})),r.d(t,"constructFeatureSetFromPortalItem",(function(){return ce})),r.d(t,"constructFeatureSetFromRelationship",(function(){return ae})),r.d(t,"constructFeatureSetFromUrl",(function(){return $})),r.d(t,"createFeatureSetCollectionFromMap",(function(){return le})),r.d(t,"createFeatureSetCollectionFromService",(function(){return se})),r.d(t,"getPortal",(function(){return ue})),r.d(t,"initialiseMetaDataCache",(function(){return X})),r.d(t,"lookupUser",(function(){return oe}));var a=r(11),n=r(4),i=r(5),l=r(6),s=r(7),u=r(15),o=r(81),c=r(60),d=r(986),f=r(932),h=r(114),y=r(642),p=r(988),_=r(934),v=r(733),g=r(718),b=r(935),m=r(655),F=r(757),w=r(933),S=r(569);var O=function(){function e(){Object(n.a)(this,e)}return Object(i.a)(e,[{key:"clone",value:function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}},{key:"toStatisticsName",value:function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}],[{key:"parseStatField",value:function(t,r,a){var n=new e;n.field=t;var i=S.WhereClause.create(r,a),l=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=S.WhereClause.create(Object(F.j)(e.parseTree.args.value[0],m.a.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(i);if(null===l)throw new Error("Invalid Statistic Function");var s=l.name.toUpperCase().trim();if("MIN"===s){if(n.typeofstat="MIN",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===s){if(n.typeofstat="MAX",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===s)n.typeofstat="COUNT",n.workingexpr=l.expr;else if("STDEV"===s){if(n.typeofstat="STDDEV",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===s){if(n.typeofstat="SUM",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===s){if(n.typeofstat="AVG",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===s){if(n.typeofstat="AVG",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==s)throw new Error("Invalid Statistic Function");if(n.typeofstat="VAR",n.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}return n}}]),e}(),k=r(838),j=r(25),I=r(44),C=r(240),D=r(366);function R(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var T=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e))._decodedStatsfield=[],a._decodedGroupbyfield=[],a._candosimplegroupby=!0,a.phsyicalgroupbyfields=[],a.objectIdField="ROW__ID",a._internalObjectIdField="ROW__ID",a._adaptedFields=[],a.declaredClass="esri.arcade.featureset.actions.Aggregate",a._uniqueIds=1,a._maxQuery=10,a._maxProcessing=10,a._parent=e.parentfeatureset,a._config=e,a}return Object(i.a)(r,[{key:"isTable",value:function(){return!0}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):Object(j.t)(this._wset)}},{key:"_isInFeatureSet",value:function(){return m.b.InFeatureSet}},{key:"nextUniqueName",value:function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t}},{key:"convertToEsriFieldType",value:function(e){return e}},{key:"_initialiseFeatureSet",value:function(){var e={},t=!1,r=1,a=this._parent?this._parent.getFieldsIndex():new D.a([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var n=!1,i=0;i<this._config.groupbyfields.length;i++)if(this._config.groupbyfields[i].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}if(!1===n)for(var l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}!1===n?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}var s,o=Object(u.a)(this._config.statsfields);try{for(o.s();!(s=o.n()).done;){var c=s.value,d=new O;d.field=c.name,d.tofieldname=c.name,d.workingexpr=c.expression instanceof S.WhereClause?c.expression:S.WhereClause.create(c.expression,a),d.typeofstat=R(c.statistic),this._decodedStatsfield.push(d)}}catch(W){o.e(W)}finally{o.f()}this._decodedGroupbyfield=[];var f,h=Object(u.a)(this._config.groupbyfields);try{for(h.s();!(f=h.n()).done;){var y=f.value,_={name:y.name,singlefield:null,tofieldname:y.name,expression:y.expression instanceof S.WhereClause?y.expression:S.WhereClause.create(y.expression,a)};this._decodedGroupbyfield.push(_)}}catch(W){h.e(W)}finally{h.f()}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";var v,g=Object(u.a)(this._parent.fields);try{for(g.s();!(v=g.n()).done;){e[v.value.name.toUpperCase()]=1}}catch(W){g.e(W)}finally{g.f()}this.types=null}else this.geometryType=m.m.point,this.typeIdField="",this.types=null,this.spatialReference=new I.a({wkid:4326});this.fields=[];var b=new O;b.field=this.nextUniqueName(e),b.tofieldname=this.objectIdField,b.workingexpr=S.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),b.typeofstat="MIN",this._decodedStatsfield.push(b);var w,k=Object(u.a)(this._decodedGroupbyfield);try{for(k.s();!(w=k.n()).done;){var j=w.value,T=new C.a;if(j.name=this.nextUniqueName(e),T.name=j.tofieldname,T.alias=T.name,Object(F.c)(j.expression)){var x=this._parent.getField(Object(F.i)(j.expression,m.a.Standardised));if(!x)throw new Error("Field is not present for Aggregation");j.name=x.name,j.singlefield=x.name,this.phsyicalgroupbyfields.push(x.name),T.type=x.type}else{T.type=this.convertToEsriFieldType(Object(F.f)(j.expression,this._parent.fields));var N=new C.a;N.name=j.name,N.alias=N.name,this.phsyicalgroupbyfields.push(j.name),this._adaptedFields.push(new p.d(N,j.expression)),this._candosimplegroupby=!1}this.fields.push(T)}}catch(W){k.e(W)}finally{k.f()}if(this._adaptedFields.length>0){var E,P=Object(u.a)(this._parent.fields);try{for(P.s();!(E=P.n()).done;){var A=E.value;this._adaptedFields.push(new p.c(A))}}catch(W){P.e(W)}finally{P.f()}}for(var L=0;L<this._decodedStatsfield.length;L++){var q=new C.a,G=null,B=this._decodedStatsfield[L];B.field=this.nextUniqueName(e),B.tofieldname===this.objectIdField&&(this._internalObjectIdField=B.field),q.name=B.tofieldname,q.alias=q.name;var U=null!==B.workingexpr&&Object(F.c)(B.workingexpr)?Object(F.i)(B.workingexpr,m.a.Standardised):"";switch(this._decodedStatsfield[L].typeofstat){case"SUM":if(""!==U){if(!(G=this._parent.getField(U)))throw new Error("Field is not present for Aggregation");q.type=G.type}else q.type="double";break;case"MIN":case"MAX":if(""!==U){if(!(G=this._parent.getField(U)))throw new Error("Field is not present for Aggregation");q.type=G.type}else q.type="double";break;case"COUNT":q.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==U&&!(G=this._parent.getField(U)))throw new Error("Field is not present for Aggregation");q.type="double"}this.fields.push(q)}}},{key:"_canDoAggregates",value:function(){return Object(j.t)(!1)}},{key:"_getFeatures",value:function(e,t,r,a){var n=this;-1!==t&&this._featureCache[t];var i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,a).then((function(){return n._getFeatures(e,t,r,a)})):Object(j.t)("success")}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;if(""!==e)return Object(j.t)(new g.a([],[],!0,null));var l=null,s={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==r)for(var e=0;e<i._decodedStatsfield.length;e++)if(!0===Object(F.h)(r,i._decodedStatsfield[e].tofieldname)){s.nowhereclause=!0,r=null;break}if(null!==a){s.ordered=!0;for(var t=0;t<i._decodedStatsfield.length;t++)if(!0===a.scanForField(i._decodedStatsfield[t].tofieldname)){a=null,s.ordered=!1;break}if(null!==a){var n,l=Object(u.a)(i._decodedGroupbyfield);try{for(l.s();!(n=l.n()).done;){var o=n.value;if(null===o.singlefield&&!0===a.scanForField(o.tofieldname)){a=null,s.ordered=!1;break}}}catch(c){l.e(c)}finally{l.f()}}}return!1===i._candosimplegroupby?Object(j.t)(!1):i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=null;r&&(t=i._reformulateWhereClauseWithoutGroupByFields(r));var u=null;return a&&(u=i._reformulateOrderClauseWithoutGroupByFields(a)),i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,t,u,i._internalObjectIdField).then((function(e){return i._checkCancelled(n),l=!0===s.nowhereclause?new g.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===s.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition)):new g.a(e._candidates.slice(0),e._known.slice(0),!0===s.ordered&&e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}var o=i._parent;if(i._adaptedFields.length>0&&(o=new p.a({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===s.nowhereclause)l=new g.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new _.a({parentfeatureset:o,orderbyclause:new b.a(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{var c=o;if(null!==r){var d=null;r&&(d=i._reformulateWhereClauseWithoutGroupByFields(r)),c=new f.a({parentfeatureset:c,whereclause:d})}l=new g.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new _.a({parentfeatureset:c,orderbyclause:new b.a(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return l}))}},{key:"_reformulateWhereClauseWithoutStatsFields",value:function(e){var t,r=Object(u.a)(this._decodedStatsfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;e=Object(F.g)(e,a.tofieldname,Object(F.i)(a.workingexpr,m.a.Standardised),this._parent.getFieldsIndex())}}catch(n){r.e(n)}finally{r.f()}return e}},{key:"_reformulateWhereClauseWithoutGroupByFields",value:function(e){var t,r=Object(u.a)(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.tofieldname!==a.name&&(e=Object(F.g)(e,a.tofieldname,Object(F.i)(a.expression,m.a.Standardised),this._parent.getFieldsIndex()))}}catch(n){r.e(n)}finally{r.f()}return e}},{key:"_reformulateOrderClauseWithoutGroupByFields",value:function(e){var t,r=[],a=Object(u.a)(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var n=t.value;n.tofieldname!==n.name&&r.push({field:n.tofieldname,newfield:n.name})}}catch(i){a.e(i)}finally{a.f()}return r.length>0?e.replaceFields(r):e}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}},{key:"_refineSetBlock",value:function(e,t,r){var a=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,r).then((function(){return a._refineSetBlock(e,t,r)}));this._checkCancelled(r);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,Object(j.t)(e)}catch(n){return Object(j.s)(n)}}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?Object(j.c)((function(t,n){a._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then((function(e){t(e)}),n)})):this._getAgregagtePhysicalPage(e,t,r).then((function(e){var t,r=Object(u.a)(e);try{for(r.s();!(t=r.n()).done;){var n,i=t.value,l={geometry:i.geometry,attributes:{}},s=Object(u.a)(a._decodedGroupbyfield);try{for(s.s();!(n=s.n()).done;){var o=n.value;l.attributes[o.tofieldname]=i.attributes[o.name]}}catch(y){s.e(y)}finally{s.f()}var c,d=Object(u.a)(a._decodedStatsfield);try{for(d.s();!(c=d.n()).done;){var f=c.value;l.attributes[f.tofieldname]=i.attributes[f.field]}}catch(y){d.e(y)}finally{d.f()}a._featureCache[l.attributes[a.objectIdField]]=new h.a(l)}}catch(y){r.e(y)}finally{r.f()}return e.length}))}},{key:"_sequentialGetPhysicalItem",value:function(e,t,r,a){var n=this;return Object(j.c)((function(i,l){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?i(a.length):n._nextAggregateItem(e,t,r,a,(function(l){null===l?i(a.length):(t-=1,i(n._sequentialGetPhysicalItem(e,t,r,a)))}),l)}))}},{key:"_nextAggregateItem",value:function(e,t,r,a,n,i){var l=this;try{Object(y.q)(e.pagesDefinition.internal.iterator.next()).then((function(s){if(null===s)if(null!==e.pagesDefinition.internal.workingItem){var u=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);a.push(u),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(u.attributes[l.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,n(null)}else e.pagesDefinition.internal.fullyResolved=!0,n(null);else{var o=l._generateAggregateHash(s);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[s],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){var c=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return a.push(c),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(c.attributes[l.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[s],id:o},void n(c)}e.pagesDefinition.internal.workingItem.features.push(s)}l._nextAggregateItem(e,t,r,a,n,i)}}),i)}catch(s){i(s)}}},{key:"_calculateFieldStat",value:function(e,t,r){for(var a=[],n=0;n<e.features.length;n++)if(null!==t.workingexpr){var i=t.workingexpr.calculateValue(e.features[n]);null!==i&&a.push(i)}else a.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=Object(w.a)("min",a,-1);break;case"MAX":r.attributes[t.tofieldname]=Object(w.a)("max",a,-1);break;case"SUM":r.attributes[t.tofieldname]=Object(w.a)("sum",a,-1);break;case"COUNT":r.attributes[t.tofieldname]=a.length;break;case"VAR":r.attributes[t.tofieldname]=Object(w.a)("var",a,-1);break;case"STDDEV":r.attributes[t.tofieldname]=Object(w.a)("stddev",a,-1);break;case"AVG":r.attributes[t.tofieldname]=Object(w.a)("avg",a,-1)}return!0}},{key:"_calculateAndAppendAggregateItem",value:function(e){var t,r={attributes:{},geometry:null},a=Object(u.a)(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var n=t.value,i=n.singlefield?e.features[0].attributes[n.singlefield]:n.expression.calculateValue(e.features[0]);r.attributes[n.tofieldname]=i}}catch(f){a.e(f)}finally{a.f()}var l,s=Object(u.a)(this._decodedStatsfield);try{for(s.s();!(l=s.n()).done;){var o=l.value;this._calculateFieldStat(e,o,r)}}catch(f){s.e(f)}finally{s.f()}for(var c=[],d=0;d<this._decodedStatsfield.length;d++)c.push(this._calculateFieldStat(e,this._decodedStatsfield[d],r));return this._featureCache[r.attributes[this.objectIdField]]=new h.a({attributes:r.attributes,geometry:r.geometry}),r}},{key:"_generateAggregateHash",value:function(e){var t,r="",a=Object(u.a)(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var n=t.value,i=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);r+=null==i?":":":"+i.toString()}}catch(l){a.e(l)}finally{a.f()}return Object(k.a)(r,k.b.String)}},{key:"_stat",value:function(){return Object(j.t)({calculated:!1})}},{key:"getFeatureByObjectId",value:function(){return Object(j.t)(null)}}],[{key:"registerAction",value:function(){v.a._featuresetFunctions.groupby=function(e,t){return new r({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}]),r}(v.a),x=r(989),N=r(990),E=r(802),P=r(82),A=r(270),L=r(439),q=r(494),G=r(145),B=r(98),U=r(391),W=r(492),M=r(182),Q=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",a._removeGeometry=!1,a._overrideFields=null,a.formulaCredential=null,a._pageJustIds=!1,a._requestStandardised=!1,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),a}return Object(i.a)(r,[{key:"_maxQueryRate",value:function(){return m.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(e){this._pageJustIds=e}},{key:"convertQueryToLruCacheKey",value:function(e){var t=Object(m.q)(e.toJSON());return Object(k.a)(t,k.b.String)}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(j.c)((function(t,r){try{if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(a){r(a)}}),r),e._layer.load()}catch(a){r(a)}}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=Object(u.a)(this.fields);try{for(r.s();!(e=r.n()).done;){var a=e.value;if("oid"===a.type)t.push(a);else{var n,i=Object(u.a)(this._layer.outFields);try{for(i.s();!(n=i.n()).done;){if(n.value.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}catch(g){i.e(g)}finally{i.f()}}}}catch(g){r.e(g)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var l,s=[],o=[],c=Object(u.a)(this.fields);try{for(c.s();!(l=c.n()).done;){var d=l.value;if("oid"===d.type)s.push(d),o.push(d.name);else{var f,h=Object(u.a)(this._overrideFields);try{for(h.s();!(f=h.n()).done;){if(f.value.toLowerCase()===d.name.toLowerCase()){s.push(d),o.push(d.name);break}}}catch(g){h.e(g)}finally{h.f()}}}}catch(g){c.e(g)}finally{c.f()}this.fields=s,this._overrideFields=o}if(this._layer.source&&this._layer.source.sourceJSON){var y=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=m.a.StandardisedNoInterval,null!=y&&y>=10.61&&(this._databaseType=m.a.Standardised)):null!=y&&(y>=10.5&&(this._databaseType=m.a.StandardisedNoInterval,this._requestStandardised=!0),y>=10.61&&(this._databaseType=m.a.Standardised))}this.objectIdField=this._layer.objectIdField;var p,_=Object(u.a)(this.fields);try{for(_.s();!(p=_.n()).done;){var v=p.value;"global-id"===v.type&&(this.globalIdField=v.name)}}catch(g){_.e(g)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"_isInFeatureSet",value:function(){return m.b.InFeatureSet}},{key:"_refineSetBlock",value:function(e){return Object(j.t)(e)}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(j.t)(this._wset)}},{key:"_runDatabaseProbe",value:function(e){var t=this;return Object(j.c)((function(r,a){try{t._ensureLoaded().then((function(){try{var n=new B.a;n.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryObjectIds(n).then((function(){r(!0)}),(function(){try{r(!1)}catch(e){a(e)}}))}catch(i){a(i)}}))}catch(n){a(n)}}))}},{key:"_canUsePagination",value:function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return this._layer.url}},{key:"pbfSupportedForQuery",value:function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}},{key:"queryPBF",value:function(e){return e.quantizationParameters={mode:"edit"},Object(M.executeQueryPBF)(this._layer.parsedUrl,e,new q.b({})).then((function(e){return G.default.fromJSON(Object(L.j)(e.data)).unquantize()}))}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}},{key:"executeQuery",value:function(e,t){var r=this,a=new W.a({url:this._layer.parsedUrl.path}),n="execute"===t&&this.pbfSupportedForQuery(e),i=null;if(this.recentlyUsedQueries){var l=this.convertQueryToLruCacheKey(e);null===(i=this.recentlyUsedQueries.getFromCache(l))&&(i=!0!==n?a[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(l,i),i=i.catch((function(e){throw r.recentlyUsedQueries.removeFromCache(l),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===i&&(i=!0!==n?a[t](e):this.queryPBF(e)),i}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this.databaseType().then((function(l){if(i.isTable()&&t&&null!==e&&""!==e)return new g.a([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,r,a,n);var s="",u=!1;null!==a&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(s=a.constructClause(),u=!0);var o=new B.a;return o.where=null===r?null===t?"1=1":"":Object(F.i)(r,l),i._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=i._makeRelationshipEnum(e),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==s?s.split(","):null,o.geometry=null===t?null:t,o.relationParameter=i._makeRelationshipParam(e),i.executeQuery(o,"executeForIds").then((function(e){return null===e&&(e=[]),i._checkCancelled(n),new g.a([],e,u,null)}))}))}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,a,n){var i=this;try{var l="",s=!1;return null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=a.constructClause(),s=!0),this.databaseType().then((function(a){var u=null===r?null===t?"1=1":"":Object(F.i)(r,a);i._layer.definitionExpression&&(u=""!==u?"(("+i._layer.definitionExpression+") AND ("+u+"))":i._layer.definitionExpression);var o=i._maxQueryRate(),c=i._layer.capabilities.query.maxRecordCount;void 0!==c&&c<o&&(o=c);var d=null;if(!0===i._pageJustIds)d=new g.a([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var f=!0;!0===i._removeGeometry&&(f=!1);var h=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);d=new g.a([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:l,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return i._expandPagedSet(d,o,0,1,n).then((function(){return d}))}))}catch(u){return Object(j.s)(u)}}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;try{var n=e.pagesDefinition.internal.lastRetrieved,i=n,l=e.pagesDefinition.internal.lastPage,s=new B.a;return this._requestStandardised&&(s.sqlFormat="standard"),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParameter=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastPage,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,this.executeQuery(s,"execute").then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastPage!==l)return"done";for(var s=0;s<t.features.length;s++)e.pagesDefinition.internal.set[i+s]=t.features[s].attributes[a._layer.objectIdField];if(!1===a._pageJustIds)for(var u=0;u<t.features.length;u++)a._featureCache[t.features[u].attributes[a._layer.objectIdField]]=t.features[u];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(u){return Object(j.s)(u)}}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,a=!1,n=Object(u.a)(t);try{for(n.s();!(r=n.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){a=!0;break}}}catch(i){n.e(i)}finally{n.f()}return!1===a&&t.push(this.objectIdField),t}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[];try{if(-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));for(var l=0,s=e._lastFetchedIndex;s<e._known.length;s++){if(e._lastFetchedIndex+=1,l++,void 0===this._featureCache[e._known[s]]){var u=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var o=this._layer._mode;if(void 0!==o._featureMap[e._known[s]]){var c=o._featureMap[e._known[s]];null!==c&&(u=!0,this._featureCache[e._known[s]]=c)}}if(!1===u&&(e._known[s]!==t&&i.push(e._known[s]),i.length>=this._maxProcessingRate()-1))break}if(l>=r&&0===i.length)break}if(0===i.length)return Object(j.t)("success");try{var d=new B.a;return this._requestStandardised&&(d.sqlFormat="standard"),d.objectIds=i,d.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),d.returnGeometry=!0,!0===this._removeGeometry&&(d.returnGeometry=!1),d.outSpatialReference=this.spatialReference,this.executeQuery(d,"execute").then((function(e){if(n._checkCancelled(a),void 0!==e.error)return Object(j.s)(new Error(e.error));for(var t=0;t<e.features.length;t++)n._featureCache[e.features[t].attributes[n._layer.objectIdField]]=e.features[t];return"success"}))}catch(f){return Object(j.s)(f)}}catch(f){return Object(j.s)(f)}}},{key:"_getDistinctPages",value:function(e,t,r,a,n,i,l,s,u){var o=this;return this._ensureLoaded().then((function(){return o.databaseType()})).then((function(c){for(var d=r.parseTree.column,f=0;f<o._layer.fields.length;f++)if(o._layer.fields[f].name.toLowerCase()===d.toLowerCase()){d=o._layer.fields[f].name;break}var h=new B.a;o._requestStandardised&&(h.sqlFormat="standard");var y=null===i?null===n?"1=1":"":Object(F.i)(i,c);return o._layer.definitionExpression&&(y=""!==y?"(("+o._layer.definitionExpression+") AND ("+y+"))":o._layer.definitionExpression),h.where=y,h.spatialRelationship=o._makeRelationshipEnum(a),h.relationParameter=o._makeRelationshipParam(a),h.geometry=null===n?null:n,h.returnDistinctValues=!0,h.returnGeometry=!1,h.outFields=[d],o.executeQuery(h,"execute").then((function(c){if(o._checkCancelled(u),!c.hasOwnProperty("features"))return Object(j.s)(new Error("Unnexected Result querying statistics from layer"));for(var f=!1,h=0;h<o._layer.fields.length;h++)if(o._layer.fields[h].name===d){"date"===o._layer.fields[h].type&&(f=!0);break}for(var y=0;y<c.features.length;y++){if(f){var p=c.features[y].attributes[d];null!==p?s.push(new Date(p)):s.push(p)}else s.push(c.features[y].attributes[d]);if(s.length>=l)break}return 0===c.features.length?s:c.features.length===o._layer.capabilities.query.maxRecordCount&&s.length<l?o._getDistinctPages(e+c.features.length,t,r,a,n,i,l,s,u).then((function(e){return{calculated:!0,result:e}})):s}))}))}},{key:"_distinctStat",value:function(e,t,r,a,n,i,l){return this._getDistinctPages(0,e,t,r,a,n,i,[],l).then((function(e){return{calculated:!0,result:e}}))}},{key:"isTable",value:function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}},{key:"_countstat",value:function(e,t,r,a){var n=this;return this.databaseType().then((function(e){var i=new B.a;if(n._requestStandardised&&(i.sqlFormat="standard"),n.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var l=null===a?null===r?"1=1":"":Object(F.i)(a,e);return n._layer.definitionExpression&&(l=""!==l?"(("+n._layer.definitionExpression+") AND ("+l+"))":n._layer.definitionExpression),i.where=l,i.where=l,i.spatialRelationship=n._makeRelationshipEnum(t),i.relationParameter=n._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1,n.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))}},{key:"_stats",value:function(e,t,r,a,n,i,l){var s=this;return this._ensureLoaded().then((function(){var u=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsSqlExpression,o=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsStatistics,c=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsDistinct;return"count"===e?c?s._countstat(e,r,a,n):{calculated:!1}:!1===o||!1===Object(F.c)(t)&&!1===u||!1===t.isStandardized?""!==r||null!==n?{calculated:!1}:s._manualStat(e,t,i,l):"distinct"===e?!1===c?""!==r||null!==n?{calculated:!1}:s._manualStat(e,t,i,l):s._distinctStat(e,t,r,a,n,i,l):s.databaseType().then((function(i){if(s.isTable()&&a&&null!==r&&""!==r)return{calculated:!0,result:null};var l=new B.a;s._requestStandardised&&(l.sqlFormat="standard");var u=null===n?null===a?"1=1":"":Object(F.i)(n,i);s._layer.definitionExpression&&(u=""!==u?"(("+s._layer.definitionExpression+") AND ("+u+"))":s._layer.definitionExpression),l.where=u,l.spatialRelationship=s._makeRelationshipEnum(r),l.relationParameter=s._makeRelationshipParam(r),l.geometry=null===a?null:a;var o=new U.a;o.statisticType=Object(w.c)(e),o.onStatisticField=Object(F.i)(t,i),o.outStatisticFieldName="ARCADE_STAT_RESULT",l.returnGeometry=!1;var c="ARCADE_STAT_RESULT";return l.outStatistics=[o],s.executeQuery(l,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return Object(j.s)(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){c=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){var a=e.features[0].attributes[c];return null!==a&&(a=new Date(e.features[0].attributes[c])),{calculated:!0,result:a}}return{calculated:!0,result:e.features[0].attributes[c]}}))}))}))}},{key:"_stat",value:function(e,t,r,a,n,i,l){return this._stats(e,t,r,a,n,i,l)}},{key:"_canDoAggregates",value:function(e,t){var r=this;return this._ensureLoaded().then((function(){var e=!1,a=r._layer.capabilities&&r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsSqlExpression;if(void 0!==r._layer.capabilities&&null!==r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsStatistics&&!0===r._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var n=0;n<t.length-1;n++)null!==t[n].workingexpr&&(!1===t[n].workingexpr.isStandardized||!1===Object(F.c)(t[n].workingexpr)&&!1===a)&&(e=!1);return!1!==e}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,l){var s=this;return this._ensureLoaded().then((function(){return s.databaseType()})).then((function(u){var o="",c=!1,d=!1;null!==i&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),d=!0),s._layer.capabilities&&s._layer.capabilities.query&&!1===s._layer.capabilities.query.supportsPagination&&(d=!1,c=!0,o=s._layer.objectIdField);for(var f=[],h=0;h<t.length;h++){var y=new U.a;y.onStatisticField=null!==t[h].workingexpr?Object(F.i)(t[h].workingexpr,u):"",y.outStatisticFieldName=t[h].field,y.statisticType=t[h].toStatisticsName(),f.push(y)}""===o&&(o=e.join(","));var p=s._maxQueryRate(),_=s._layer.capabilities.query.maxRecordCount;void 0!==_&&_<p&&(p=_);var v=null===n?null===a?"1=1":"":Object(F.i)(n,u);return s._layer.definitionExpression&&(v=""!==v?"(("+s._layer.definitionExpression+") AND ("+v+"))":s._layer.definitionExpression),new g.a([],["GETPAGES"],d,{groupbypage:!0,spatialRel:s._makeRelationshipEnum(r),relationParam:s._makeRelationshipParam(r),outFields:["*"],useOIDpagination:c,generatedOid:l,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:f,geometry:null===a?null:a,where:v,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}},{key:"_getAgregagtePhysicalPage",value:function(e,t,r){var a=this;try{var n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var i=e.pagesDefinition.internal.lastRetrieved,l=i,s=e.pagesDefinition.internal.lastPage,u=new B.a;return this._requestStandardised&&(u.sqlFormat="standard"),u.where=n,u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields,u.outStatistics=e.pagesDefinition.outStatistics,u.geometry=e.pagesDefinition.geometry,u.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.returnGeometry=e.pagesDefinition.returnGeometry,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship?Object(j.t)([]):this.executeQuery(u,"execute").then((function(t){if(a._checkCancelled(r),!t.hasOwnProperty("features"))return Object(j.s)(new Error("Unnexected Result querying aggregates from layer"));var n=[];if(e.pagesDefinition.internal.lastPage!==s)return[];for(var u=0;u<t.features.length;u++)e.pagesDefinition.internal.set[l+u]=t.features[u].attributes[e.pagesDefinition.generatedOid];for(var o=0;o<t.features.length;o++)n.push(new h.a({attributes:t.features[o].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,n}))}catch(o){return Object(j.s)(o)}}},{key:"relationshipMetaData",value:function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}},{key:"serviceUrl",value:function(){return Object(m.i)(this._layer.parsedUrl.path)}},{key:"queryAttachments",value:function(e,t,r,a){var n=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var i={objectIds:[e]};return(t&&t>0||r&&r>0)&&(i.size=[t&&t>0?t:0,r&&r>0?r:t+1]),a&&a.length>0&&(i.attachmentTypes=a),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:i,method:"attachments"}),this._layer.queryAttachments(i).then((function(t){var r=[];return t&&t[e]&&t[e].forEach((function(t){var a=n._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new E.a(t.id,t.name,t.contentType,t.size,a))})),r}))}return Object(j.t)([])}},{key:"queryRelatedFeatures",value:function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),Object(c.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},r=e.data;if(r&&r.relatedRecordGroups){var a,n=r.spatialReference,i=Object(u.a)(r.relatedRecordGroups);try{for(i.s();!(a=i.n()).done;){var l,s=a.value,o=s.objectId,c=[],d=Object(u.a)(s.relatedRecords);try{for(d.s();!(l=d.n()).done;){var f=l.value;f.geometry&&(f.geometry.spatialReference=n);var y=new h.a({geometry:f.geometry?Object(P.a)(f.geometry):null,attributes:f.attributes});c.push(y)}}catch(p){d.e(p)}finally{d.f()}t[o]={features:c,exceededTransferLimit:!0===r.exceededTransferLimit}}}catch(p){i.e(p)}finally{i.f()}}return t}return Object(j.s)("Invalid Request")}))}},{key:"getFeatureByObjectId",value:function(e,t){var r=new W.a({url:this._layer.parsedUrl.path}),a=new B.a;return a.outFields=t,a.returnGeometry=!1,a.outSpatialReference=this.spatialReference,a.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:a,method:"execute"}),r.execute(a).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getIdentityUser",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=o.b)?void 0:t.findCredential(e._layer.url);return r?r.userId:null}))}},{key:"getOwningSystemUrl",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=o.b)?void 0:t.findServerInfo(e._layer.url);if(r)return Object(j.t)(r.owningSystemUrl);var a=e._layer.url,n=a.toLowerCase().indexOf("/rest/services");return(a=n>-1?a.substring(0,n):a)?(a+="/rest/info",Object(j.c)((function(e,t){Object(c.default)(a,{query:{f:"json"}}).then((function(t){var r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)}),(function(t){e("")}))}))):Object(j.t)("")}))}}],[{key:"create",value:function(e,t,a,n,i){return new r({layer:new A.default({url:e,outFields:null===t?["*"]:t}),spatialReference:a,lrucache:n,interceptor:i})}}]),r}(v.a),V=r(991),J=r(191),K=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",a._findObjectId=-1,a._requestStandardised=!1,a._removeGeometry=!1,a._overrideFields=null,a.featureObjectId=null,a.relatedLayer=null,a.relationship=null,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,a._findObjectId=e.objectId,a.featureObjectId=e.objectId,a.relationship=e.relationship,a.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),a}return Object(i.a)(r,[{key:"_maxQueryRate",value:function(){return m.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(j.c)((function(t,r){Object(j.b)([e._layer.load(),e.relatedLayer.load()]).then((function(){e._initialiseFeatureSet(),t(e)}),r)}))),this._loadPromise}},{key:"nativeCapabilities",value:function(){return this.relatedLayer.nativeCapabilities()}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var e,t=[],r=[],a=Object(u.a)(this.fields);try{for(a.s();!(e=a.n()).done;){var n=e.value;if("oid"===n.type)t.push(n),r.push(n.name);else{var i,l=Object(u.a)(this._overrideFields);try{for(l.s();!(i=l.n()).done;){if(i.value.toLowerCase()===n.name.toLowerCase()){t.push(n),r.push(n.name);break}}}catch(o){l.e(o)}finally{l.f()}}}}catch(o){a.e(o)}finally{a.f()}this.fields=t,this._overrideFields=r}var s=this._layer.nativeCapabilities();s&&(this._databaseType=s.databaseType,this._requestStandardised=s.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}},{key:"databaseType",value:function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))}},{key:"isTable",value:function(){return this.relatedLayer.isTable()}},{key:"_isInFeatureSet",value:function(){return m.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(j.t)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},a=Object(u.a)(this.fields);try{for(a.s();!(t=a.n()).done;){var n=t.value;r[n.name]=e.attributes[n.name]}}catch(i){a.e(i)}finally{a.f()}return new h.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this.databaseType().then((function(){if(i.isTable()&&t&&null!==e&&""!==e)return new g.a([],[],!0,null);var l=i._layer.nativeCapabilities();if(!1===l.canQueryRelated)return new g.a([],[],!0,null);if(l.capabilities.queryRelated&&l.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,r,a,n);var s="",u=!1;null!==a&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(s=a.constructClause(),u=!0);var o=new J.a;o.objectIds=[i._findObjectId];var c=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);o.outFields=c,o.relationshipId=i.relationship.id,o.where="1=1";var d=!0;return!0===i._removeGeometry&&(d=!1),o.returnGeometry=d,i._requestStandardised&&(o.sqlFormat="standard"),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==s?s.split(","):null,l.source.queryRelatedFeatures(o).then((function(a){i._checkCancelled(n);for(var l=a[i._findObjectId]?a[i._findObjectId].features:[],s=[],o=0;o<l.length;o++)i._featureCache[l[o].attributes[i._layer.objectIdField]]=l[o],s.push(l[o].attributes[i._layer.objectIdField]);var c=t&&null!==e&&""!==e,d=null!=r;return new g.a(c||d?s:[],c||d?[]:s,u,null)}))}))}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,a=!1,n=Object(u.a)(t);try{for(n.s();!(r=n.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){a=!0;break}}}catch(i){n.e(i)}finally{n.f()}return!1===a&&t.push(this.objectIdField),t}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,a,n){var i=this;try{var l="",s=!1,u=this._layer.nativeCapabilities();return null!==a&&u&&u.capabilities.queryRelated&&!0===u.capabilities.queryRelated.supportsOrderBy&&(l=a.constructClause(),s=!0),this.databaseType().then((function(){var a=i._maxQueryRate(),o=u.capabilities.query.maxRecordCount;void 0!==o&&o<a&&(a=o);var c,d=t&&null!==e&&""!==e,f=null!=r,h=!0;!0===i._removeGeometry&&(h=!1);var y=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);return c=new g.a(d||f?["GETPAGES"]:[],d||f?[]:["GETPAGES"],s,{outFields:y.join(","),resultRecordCount:a,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:l,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),i._expandPagedSet(c,a,0,0,n).then((function(){return c}))}))}catch(o){return Object(j.s)(o)}}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;try{var n=e.pagesDefinition.internal.lastRetrieved,i=n,l=e.pagesDefinition.internal.lastPage,s=this._layer.nativeCapabilities(),u=new J.a;return!0===this._requestStandardised&&(u.sqlFormat="standard"),u.relationshipId=this.relationship.id,u.objectIds=e.pagesDefinition.objectIds,u.resultOffset=e.pagesDefinition.internal.lastPage,u.resultRecordCount=e.pagesDefinition.resultRecordCount,u.outFields=e.pagesDefinition.outFields.split(","),u.where=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,s.source.queryRelatedFeatures(u).then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastPage!==l)return 0;for(var s=t[a._findObjectId]?t[a._findObjectId].features:[],u=0;u<s.length;u++)e.pagesDefinition.internal.set[i+u]=s[u].attributes[a._layer.objectIdField];for(var o=0;o<s.length;o++)a._featureCache[s[o].attributes[a._layer.objectIdField]]=s[o];var c=!t[a._findObjectId]||!1===t[a._findObjectId].exceededTransferLimit;return s.length!==e.pagesDefinition.resultRecordCount&&c&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+s.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,s.length}))}catch(o){return Object(j.s)(o)}}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);var l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));for(var s=0,u=e._lastFetchedIndex;u<e._known.length&&(++s<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[u]&&void 0===this._featureCache[e._known[u]]&&(e._known[u]!==t&&i.push(e._known[u]),i.length>r)))&&!(s>=r&&0===i.length);u++);return 0===i.length?Object(j.t)("success"):Object(j.s)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e,t,r){return Object(j.t)(e)}},{key:"_stat",value:function(e,t,r,a,n,i,l){return Object(j.t)({calculated:!1})}},{key:"gdbVersion",get:function(){return this.relatedLayer.gdbVersion}},{key:"_canDoAggregates",value:function(e,t,r,a,n){return Object(j.t)(!1)}},{key:"relationshipMetaData",value:function(){return this.relatedLayer.relationshipMetaData()}},{key:"serviceUrl",value:function(){return this.relatedLayer.serviceUrl()}},{key:"queryAttachments",value:function(e,t,r,a){return this.relatedLayer.queryAttachments(e,t,r,a)}},{key:"getFeatureByObjectId",value:function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this.relatedLayer.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this.relatedLayer.getIdentityUser()}}]),r}(v.a),z=r(987),Z=r(104),H=r(343);function X(){null===z.a.applicationCache&&(z.a.applicationCache=new z.a)}function Y(e,t){if(z.a.applicationCache){var r=z.a.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return Object(j.t)(new A.default({url:e,outFields:t,sourceJSON:r}))}));var a=new A.default({url:e,outFields:t}),n=Object(j.c)((function(e,t){a.load().then((function(){e(a.sourceJSON)}),(function(e){t(e)}))}));return z.a.applicationCache&&(z.a.applicationCache.setLayerInfo(e,n),n=n.catch((function(t){throw z.a.applicationCache.clearLayerInfo(e),t}))),n.then((function(){return Object(j.t)(a)}))}return Object(j.t)(new A.default({url:e,outFields:t}))}function $(e,t,r,a,n){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return Y(e,["*"]).then((function(e){return Object(j.t)(ee(e,t,r,a,n,i))}))}function ee(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return!0===e._hasMemorySource()?new V.a({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n,interceptor:i}):new Q({layer:e,spatialReference:t,outFields:r,includeGeometry:a,lrucache:n,interceptor:i})}function te(e){if(null!==z.a.applicationCache){var t=z.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=Object(c.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),Object(j.t)(t)}return Object(j.t)({layers:[],tables:[]})}));return null!==z.a.applicationCache&&(z.a.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw z.a.applicationCache.clearLayerInfo(e),t}))),r}function re(e,t){var r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return te(e).then((function(a){if(r.metadata=a,a.controllerDatasetLayers&&void 0!==a.controllerDatasetLayers.utilityNetworkLayerId&&null!==a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers){var n,i=Object(u.a)(a.layers);try{for(i.s();!(n=i.n()).done;){var l=n.value;r.layerNameLkp[l.id]=l.name}}catch(h){i.e(h)}finally{i.f()}}if(a.tables){var s,o=Object(u.a)(a.tables);try{for(o.s();!(s=o.n()).done;){var d=s.value;r.layerNameLkp[d.id]=d.name}}catch(h){o.e(h)}finally{o.f()}}var f=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=f,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==z.a.applicationCache){var a=z.a.applicationCache.getLayerInfo(r);if(null!==a)return a}var n=Object(c.default)(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==z.a.applicationCache&&(z.a.applicationCache.setLayerInfo(r,n),n=n.catch((function(e){throw z.a.applicationCache.clearLayerInfo(r),e}))),n}(e,f).then((function(a){if(a){r.queryelem=a,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);var n,i=Object(u.a)(r.queryelem.dataElement.domainNetworks);try{for(i.s();!(n=i.n()).done;){var l,s=n.value,o=Object(u.a)(s.edgeSources?s.edgeSources:[]);try{for(o.s();!(l=o.n()).done;){var d=l.value,y={layerId:d.layerId,sourceId:d.sourceId,className:r.layerNameLkp[d.layerId]?r.layerNameLkp[d.layerId]:null};y.className&&(r.lkp[y.className]=y)}}catch(h){o.e(h)}finally{o.f()}var p,_=Object(u.a)(s.junctionSources?s.junctionSources:[]);try{for(_.s();!(p=_.n()).done;){var v=p.value,g={layerId:v.layerId,sourceId:v.sourceId,className:r.layerNameLkp[v.layerId]?r.layerNameLkp[v.layerId]:null};g.className&&(r.lkp[g.className]=g)}}catch(h){_.e(h)}finally{_.f()}}}catch(h){i.e(h)}finally{i.f()}if(r.queryelem.dataElement.terminalConfigurations){var b,m=Object(u.a)(r.queryelem.dataElement.terminalConfigurations);try{for(m.s();!(b=m.n()).done;){var F,w=b.value,O=Object(u.a)(w.terminals);try{for(O.s();!(F=O.n()).done;){var k=F.value;r.terminals.push({terminalId:k.terminalId,terminalName:k.terminalName})}}catch(h){O.e(h)}finally{O.f()}}}catch(h){m.e(h)}finally{m.f()}}return function(e){if(null!==z.a.applicationCache){var t=z.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=Object(c.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return Object(j.t)(t)}return Object(j.t)(null)}));return null!==z.a.applicationCache&&(z.a.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw z.a.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+f).then((function(a){if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){var n=[];return r.unVersion>=4&&(n.push("STATUS"),n.push("PERCENTALONG")),$(e+"/"+a.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"].concat(n),!1,null,null).then((function(e){return e.load()})).then((function(e){return r.unVersion>=4?(e=e.filter(S.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function ae(e,t,r){var a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=e.serviceUrl();return u?$(u="/"===u.charAt(u.length-1)?u+t.relatedTableId.toString():u+"/"+t.relatedTableId.toString(),a,n,i,l,s).then((function(u){return new K({layer:e,relatedLayer:u,relationship:t,objectId:r,spatialReference:a,outFields:n,includeGeometry:i,lrucache:l,interceptor:s})})):null}f.a.registerAction(),T.registerAction(),_.a.registerAction(),x.a.registerAction(),N.a.registerAction();var ne=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return Object(n.a)(this,r),(a=t.call(this))._map=e,a._overridespref=i,a.lrucache=l,a.interceptor=s,a._instantLayers=[],a}return Object(i.a)(r,[{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetByName(e,r,n)}catch(i){return Object(j.s)(i)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var i=JSON.stringify(n),l=0;l<this._instantLayers.length;l++){var s=this._instantLayers[l];if(s.opitem.title===e&&s.includeGeometry===r&&s.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.layers.find((function(t){return t instanceof A.default&&t.title===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,r,n));if(this._map.tables){var o=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(o){if(o instanceof A.default)return this.resolvePromise(this.makeAndAddFeatureSet(o,r,n));if(o._materializedTable);else{var c=o.outFields?o:Object(a.a)(Object(a.a)({},o),{},{outFields:["*"]});o._materializedTable=new A.default(c)}return o._materializedTable.load().then((function(){return t.resolvePromise(t.makeAndAddFeatureSet(o._materializedTable,r,n))}))}}return this.resolvePromise(null)}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return t.featureSetById(e,r,n)}catch(i){return Object(j.s)(i)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var i=JSON.stringify(n),l=0;l<this._instantLayers.length;l++){var s=this._instantLayers[l];if(s.opitem.id===e&&s.includeGeometry===r&&s.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}var u=this._map.layers.find((function(t){return t instanceof A.default&&t.id===e}));if(u)return this.resolvePromise(this.makeAndAddFeatureSet(u,r,n));if(this._map.tables){var o=this._map.tables.find((function(t){return t.id===e}));if(o){if(o instanceof A.default)return this.resolvePromise(this.makeAndAddFeatureSet(o,r,n));if(o._materializedTable);else{var c=Object(a.a)(Object(a.a)({},o),{},{outFields:["*"]});o._materializedTable=new A.default(c)}return o._materializedTable.load().then((function(){return t.resolvePromise(t.makeAndAddFeatureSet(o._materializedTable,r,n))}))}}return this.resolvePromise(null)}}]),r}(d.a),ie=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return Object(n.a)(this,r),(a=t.call(this))._url=e,a._overridespref=i,a.lrucache=l,a.interceptor=s,a.metadata=null,a._instantLayers=[],a}return Object(i.a)(r,[{key:"url",get:function(){return this._url}},{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:a,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),a}},{key:"_loadMetaData",value:function(){var e=this;return te(this._url).then((function(t){return e.metadata=t,t}))}},{key:"load",value:function(){return this._loadMetaData()}},{key:"clone",value:function(){return new r(this._url,this._overridespref,this.lrucache,this.interceptor)}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var n=JSON.stringify(a),i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.title===e&&l.includeGeometry===r&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){var i,l=null,s=Object(u.a)(n.layers?n.layers:[]);try{for(s.s();!(i=s.n()).done;){var o=i.value;o.name===e&&(l=o)}}catch(h){s.e(h)}finally{s.f()}if(!l){var c,d=Object(u.a)(n.tables?n.tables:[]);try{for(d.s();!(c=d.n()).done;){var f=c.value;f.name===e&&(l=f)}}catch(h){d.e(h)}finally{d.f()}}return l?Y(t._url+"/"+l.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,r,a)})):t.resolvePromise(null)}))}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];null===a&&(a=["*"]),a=(a=a.slice(0)).sort();var n=JSON.stringify(a);e=null!=e?e.toString():"";for(var i=0;i<this._instantLayers.length;i++){var l=this._instantLayers[i];if(l.opitem.id===e&&l.includeGeometry===r&&l.outFields===n)return this.resolvePromise(this._instantLayers[i].featureset)}return this._loadMetaData().then((function(n){var i,l=null,s=Object(u.a)(n.layers?n.layers:[]);try{for(s.s();!(i=s.n()).done;){var o=i.value;null!==o.id&&void 0!==o.id&&o.id.toString()===e&&(l=o)}}catch(h){s.e(h)}finally{s.f()}if(!l){var c,d=Object(u.a)(n.tables?n.tables:[]);try{for(d.s();!(c=d.n()).done;){var f=c.value;null!==f.id&&void 0!==f.id&&f.id.toString()===e&&(l=f)}}catch(h){d.e(h)}finally{d.f()}}return l?Y(t._url+"/"+l.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,r,a)})):t.resolvePromise(null)}))}}]),r}(d.a);function le(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ne(e,t,r,a)}function se(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ie(e,t,r,a)}function ue(e,t){return null===e?t:new Z.a({url:e.field("url")})}function oe(e,t,r){return o.b.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===t&&e.user&&e.user.sourceJSON&&!1===r?Object(j.t)(e.user.sourceJSON):""===t?Object(c.default)(e.restUrl+"/community/self",{responseType:"json",query:Object(a.a)({f:"json"},!1===r?{}:{returnUserLicenseTypeExtensions:!0})}).then((function(e){if(e.data){var t=e.data;if(t&&t.username)return Object(j.t)(t)}return Object(j.t)(null)})):Object(c.default)(e.restUrl+"/community/users/"+t,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.error?null:Object(j.t)(t)}return Object(j.t)(null)})):Object(j.t)(null)}function ce(e,t,r,a,n,i,l){var s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(z.a.applicationCache){var u=z.a.applicationCache.getLayerInfo(e+":"+i.url);if(u)return u.then((function(e){try{var u=new A.default({url:Object(m.i)(e.url)+"/"+t,outFields:["*"]});return Object(j.t)(ee(u,r,a,n,l,s))}catch(i){return Object(j.s)(i)}}),(function(e){return Object(j.s)(e)}))}return Object(j.c)((function(u,o){var c=new H.default({id:e,portal:i}).load();z.a.applicationCache&&z.a.applicationCache.setLayerInfo(e+":"+i.url,c),c.then((function(e){try{var c=new A.default({url:Object(m.i)(e.url)+"/"+t,outFields:["*"]});u(ee(c,r,a,n,l,s))}catch(i){o(i)}}),(function(t){z.a.applicationCache&&z.a.applicationCache.clearLayerInfo(e+":"+i.url),o(t)}))}))}},838:function(e,t,r){"use strict";r.d(t,"a",(function(){return p})),r.d(t,"b",(function(){return a}));var a={Base64:0,Hex:1,String:2,Raw:3};function n(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function i(e){for(var t=[],r=0,a=8*e.length;r<a;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}function l(e){for(var t=[],r=0,a=32*e.length;r<a;r+=8)t.push(String.fromCharCode(e[r>>5]>>>r%32&255));return t.join("")}function s(e){for(var t="0123456789abcdef",r=[],a=0,n=4*e.length;a<n;a++)r.push(t.charAt(e[a>>2]>>a%4*8+4&15)+t.charAt(e[a>>2]>>a%4*8&15));return r.join("")}function u(e){for(var t=[],r=0,a=4*e.length;r<a;r+=3)for(var n=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255,i=0;i<4;i++)8*r+6*i>32*e.length?t.push("="):t.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(n>>6*(3-i)&63));return t.join("")}function o(e,t,r,a,i,l){return n(function(e,t){return e<<t|e>>>32-t}(n(n(t,e),n(a,l)),i),r)}function c(e,t,r,a,n,i,l){return o(t&r|~t&a,e,t,n,i,l)}function d(e,t,r,a,n,i,l){return o(t&a|r&~a,e,t,n,i,l)}function f(e,t,r,a,n,i,l){return o(t^r^a,e,t,n,i,l)}function h(e,t,r,a,n,i,l){return o(r^(t|~a),e,t,n,i,l)}function y(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var r=1732584193,a=-271733879,i=-1732584194,l=271733878,s=0;s<e.length;s+=16){var u=r,o=a,y=i,p=l;r=c(r,a,i,l,e[s+0],7,-680876936),l=c(l,r,a,i,e[s+1],12,-389564586),i=c(i,l,r,a,e[s+2],17,606105819),a=c(a,i,l,r,e[s+3],22,-1044525330),r=c(r,a,i,l,e[s+4],7,-176418897),l=c(l,r,a,i,e[s+5],12,1200080426),i=c(i,l,r,a,e[s+6],17,-1473231341),a=c(a,i,l,r,e[s+7],22,-45705983),r=c(r,a,i,l,e[s+8],7,1770035416),l=c(l,r,a,i,e[s+9],12,-1958414417),i=c(i,l,r,a,e[s+10],17,-42063),a=c(a,i,l,r,e[s+11],22,-1990404162),r=c(r,a,i,l,e[s+12],7,1804603682),l=c(l,r,a,i,e[s+13],12,-40341101),i=c(i,l,r,a,e[s+14],17,-1502002290),r=d(r,a=c(a,i,l,r,e[s+15],22,1236535329),i,l,e[s+1],5,-165796510),l=d(l,r,a,i,e[s+6],9,-1069501632),i=d(i,l,r,a,e[s+11],14,643717713),a=d(a,i,l,r,e[s+0],20,-373897302),r=d(r,a,i,l,e[s+5],5,-701558691),l=d(l,r,a,i,e[s+10],9,38016083),i=d(i,l,r,a,e[s+15],14,-660478335),a=d(a,i,l,r,e[s+4],20,-405537848),r=d(r,a,i,l,e[s+9],5,568446438),l=d(l,r,a,i,e[s+14],9,-1019803690),i=d(i,l,r,a,e[s+3],14,-187363961),a=d(a,i,l,r,e[s+8],20,1163531501),r=d(r,a,i,l,e[s+13],5,-1444681467),l=d(l,r,a,i,e[s+2],9,-51403784),i=d(i,l,r,a,e[s+7],14,1735328473),r=f(r,a=d(a,i,l,r,e[s+12],20,-1926607734),i,l,e[s+5],4,-378558),l=f(l,r,a,i,e[s+8],11,-2022574463),i=f(i,l,r,a,e[s+11],16,1839030562),a=f(a,i,l,r,e[s+14],23,-35309556),r=f(r,a,i,l,e[s+1],4,-1530992060),l=f(l,r,a,i,e[s+4],11,1272893353),i=f(i,l,r,a,e[s+7],16,-155497632),a=f(a,i,l,r,e[s+10],23,-1094730640),r=f(r,a,i,l,e[s+13],4,681279174),l=f(l,r,a,i,e[s+0],11,-358537222),i=f(i,l,r,a,e[s+3],16,-722521979),a=f(a,i,l,r,e[s+6],23,76029189),r=f(r,a,i,l,e[s+9],4,-640364487),l=f(l,r,a,i,e[s+12],11,-421815835),i=f(i,l,r,a,e[s+15],16,530742520),r=h(r,a=f(a,i,l,r,e[s+2],23,-995338651),i,l,e[s+0],6,-198630844),l=h(l,r,a,i,e[s+7],10,1126891415),i=h(i,l,r,a,e[s+14],15,-1416354905),a=h(a,i,l,r,e[s+5],21,-57434055),r=h(r,a,i,l,e[s+12],6,1700485571),l=h(l,r,a,i,e[s+3],10,-1894986606),i=h(i,l,r,a,e[s+10],15,-1051523),a=h(a,i,l,r,e[s+1],21,-2054922799),r=h(r,a,i,l,e[s+8],6,1873313359),l=h(l,r,a,i,e[s+15],10,-30611744),i=h(i,l,r,a,e[s+6],15,-1560198380),a=h(a,i,l,r,e[s+13],21,1309151649),r=h(r,a,i,l,e[s+4],6,-145523070),l=h(l,r,a,i,e[s+11],10,-1120210379),i=h(i,l,r,a,e[s+2],15,718787259),a=h(a,i,l,r,e[s+9],21,-343485551),r=n(r,u),a=n(a,o),i=n(i,y),l=n(l,p)}return[r,a,i,l]}function p(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:a.Hex,r=t||a.Base64,n=y(i(e),8*e.length);switch(r){case a.Raw:return n;case a.Hex:return s(n);case a.String:return l(n);case a.Base64:return u(n)}}},932:function(e,t,r){"use strict";var a=r(4),n=r(5),i=r(6),l=r(7),s=r(733),u=r(718),o=r(655),c=r(757),d=r(25),f=r(569),h=r(44),y=function(e){Object(i.a)(r,e);var t=Object(l.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.actions.AttributeFilter",n._maxProcessing=1e3,n._parent=e.parentfeatureset,e.whereclause instanceof f.WhereClause?(n._whereclause=e.whereclause,n._whereClauseFunction=null):(n._whereClauseFunction=e.whereclause,n._whereclause=null),n}return Object(n.a)(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new h.a({wkid:4326}),this.geometryType=o.m.point)}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(r){return t._checkCancelled(e),null!==t._whereClauseFunction?t._wset=new u.a(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,t._clonePageDefinition(r.pagesDefinition)):t._wset=new u.a(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):Object(d.t)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===o.b.NotInFeatureSet?t:void 0===(t=this._idstates[e])?o.b.Unknown:t}},{key:"_getFeature",value:function(e,t,r){return this._parent._getFeature(e,t,r)}},{key:"_getFeatures",value:function(e,t,r,a){return this._parent._getFeatures(e,t,r,a)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeWhereClause",value:function(e){return this._whereclause.testFeature(e)}},{key:"executeWhereClauseDeferred",value:function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return Object(d.p)(t)?t:Object(d.t)(t)}catch(r){return Object(d.s)(r)}return Object(d.t)(this.executeWhereClause(e))}},{key:"_fetchAndRefineFeatures",value:function(e,t,r){var a=this,n=new u.a([],e,!1,null),i=Math.min(t,e.length);return this._parent._getFeatures(n,-1,i,r).then((function(){if(a._checkCancelled(r),null==a._whereClauseFunction){for(var n=0;n<i;n++){var l=a._parent._featureFromCache(e[n]);!0===a.executeWhereClause(l)?a._idstates[e[n]]=o.b.InFeatureSet:a._idstates[e[n]]=o.b.NotInFeatureSet}return"success"}for(var s=[],u=0;u<i;u++){var c=a._parent._featureFromCache(e[u]);s.push(a.executeWhereClauseDeferred(c))}return Object(d.b)(s).then((function(r){for(var n=0;n<t;n++)!0===r[n]?a._idstates[e[n]]=o.b.InFeatureSet:a._idstates[e[n]]=o.b.NotInFeatureSet;return"success"}))}))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=Object(c.a)(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,a,n)})).then((function(e){return i._checkCancelled(n),null!==i._whereClauseFunction?new u.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new u.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,r,a,n,i,l){var s=this;if(null!==this._whereClauseFunction)return null===n&&""===r&&null===a?this._manualStat(e,t,i,l):Object(d.t)({calculated:!1});var u=this._whereclause;return null!==n&&null!==this._whereclause&&(u=Object(c.a)(this._whereclause,n)),this._parent._stat(e,t,r,a,u,i,l).then((function(u){return!1===u.calculated?null===n&&""===r&&null===a?s._manualStat(e,t,i,l):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,a,n){return null!==this._whereClauseFunction?Object(d.t)(!1):(null!==n?null!==this._whereclause&&(n=Object(c.a)(this._whereclause,n)):n=this._whereclause,null===this._parent?Object(d.t)(!1):this._parent._canDoAggregates(e,t,r,a,n))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,l){return null===this._parent?Object(d.s)(new Error("Should never be called")):(null!==n?null!==this._whereclause&&(n=Object(c.a)(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,n,i,l))}}],[{key:"registerAction",value:function(){s.a._featuresetFunctions.filter=function(e){if("function"==typeof e)return new r({parentfeatureset:this,whereclause:e});var t=null;return e instanceof f.WhereClause&&(t=e),new r({parentfeatureset:this,whereclause:t})}}}]),r}(s.a);t.a=y},934:function(e,t,r){"use strict";var a=r(15),n=r(4),i=r(5),l=r(6),s=r(7),u=r(642),o=r(733),c=r(718),d=r(935),f=r(25),h=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e))._orderbyclause=null,a.declaredClass="esri.arcade.featureset.actions.OrderBy",a._maxProcessing=100,a._orderbyclause=e.orderbyclause,a._parent=e.parentfeatureset,a}return Object(i.a)(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(r){return t._checkCancelled(e),t._wset=r,t._wset})):Object(f.t)(this._wset)}},{key:"manualOrderSet",value:function(e,t){var r=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){r._orderbyclause.order(e);for(var t=new c.a([],[],!0,null),a=0;a<e.length;a++)t._known.push(e[a].id);return t}))}},{key:"getIdColumnDictionary",value:function(e,t,r,n){var i=this;if(r<e._known.length-1){var l=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return Object(u.q)(this._parent._expandPagedSet(e,l,0,0,n)).then((function(){return i.getIdColumnDictionary(e,t,r,n)}));for(var s=r+1,o=[];s<e._known.length&&"GETPAGES"!==e._known[s];)o.push(e._known[s]),s++;return r+=o.length,Object(u.q)(this._parent._getFeatureBatch(o,n)).then((function(l){i._checkCancelled(n);var s,u=Object(a.a)(l);try{for(u.s();!(s=u.n()).done;){var o=s.value;t.push({id:o.attributes[i.objectIdField],feature:o})}}catch(c){u.e(c)}finally{u.f()}return i.getIdColumnDictionary(e,t,r,n)}))}return e._candidates.length>0?Object(u.q)(this._refineSetBlock(e,this._maxProcessingRate(),n)).then((function(){return i._checkCancelled(n),i.getIdColumnDictionary(e,t,r,n)})):Object(f.t)(t)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,a){return this._parent._getFeatures(e,t,r,a)}},{key:"_featureFromCache",value:function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}},{key:"_fetchAndRefineFeatures",value:function(){return Object(f.s)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,null===a?i._orderbyclause:a,n)})).then((function(e){i._checkCancelled(n);var a=new c.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition)),l=!0;return e._candidates.length>0&&(l=!1),!1===a._ordered?i.manualOrderSet(a,n).then((function(e){return!1===l&&(null===t&&null===r||(e=new c.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)))),e})):a}))}}],[{key:"registerAction",value:function(){o.a._featuresetFunctions.orderBy=function(e){return""===e?this:new r({parentfeatureset:this,orderbyclause:new d.a(e)})}}}]),r}(o.a);t.a=h},935:function(e,t,r){"use strict";var a=r(15),n=r(4),i=r(5);function l(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}var s=function(){function e(t){Object(n.a)(this,e);var r=t.split(",");this._fields=[],this._directions=[];for(var a=0;a<r.length;a++){var i=r[a].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return Object(i.a)(e,[{key:"constructClause",value:function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}},{key:"order",value:function(e){var t=this;e.sort((function(e,r){for(var a=0;a<t._fields.length;a++){var n,i=t.featureValue(e.feature,t._fields[a],a),s=t.featureValue(r.feature,t._fields[a],a);if(0!==(n=1===t._directions[a]?l(i,s):-1*l(i,s)))return n}return 0}))}},{key:"scanForField",value:function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}},{key:"replaceFields",value:function(t){for(var r="",n=0;n<this._fields.length;n++){0!==n&&(r+=",");var i,l=this._fields[n],s=Object(a.a)(t);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(l.toLowerCase()===u.field.toLowerCase()){l=u.newfield;break}}}catch(o){s.e(o)}finally{s.f()}r+=l,1===this._directions[n]?r+=" ASC":r+=" DESC"}return new e(r)}},{key:"featureValue",value:function(e,t,r){var a=e.attributes[t];if(void 0!==a)return a;for(var n in e.attributes)if(t.toLowerCase()===n.toLowerCase())return this._fields[r]=n,e.attributes[n];return null}}]),e}();t.a=s},986:function(e,t,r){"use strict";var a=r(4),n=r(5),i=r(25),l=function(){function e(){Object(a.a)(this,e),this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return Object(n.a)(e,[{key:"add",value:function(e,t,r){this._layerById[t]=r,this._layerByName[e]=r}},{key:"featureSetByName",value:function(e){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}},{key:"featureSetById",value:function(e){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}},{key:"castToText",value:function(){return"object, FeatureSetCollection"}},{key:"resolvePromise",value:function(e){return Object(i.t)(e)}}]),e}();t.a=l},988:function(e,t,r){"use strict";r.d(t,"a",(function(){return w})),r.d(t,"b",(function(){return b})),r.d(t,"c",(function(){return g})),r.d(t,"d",(function(){return F})),r.d(t,"e",(function(){return m}));var a=r(15),n=r(6),i=r(7),l=r(4),s=r(5),u=r(114),o=r(841),c=r(733),d=r(718),f=r(655),h=r(757),y=r(25),p=r(569),_=r(44),v=function(){function e(){Object(l.a)(this,e),this.sqlRewritable=!1}return Object(s.a)(e,[{key:"postInitialization",value:function(e,t){}}]),e}(),g=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e){var a;return Object(l.a)(this,r),(a=t.call(this)).field=e,a.sqlRewritable=!0,a}return Object(s.a)(r,[{key:"extractValue",value:function(e){return e.attributes[this.field.name]}},{key:"rewriteSql",value:function(e){return{rewritten:this.sqlRewritable,where:e}}}]),r}(v),b=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e,a,n){var i;return Object(l.a)(this,r),(i=t.call(this)).originalField=e,i.sqlRewritable=!0,i.field=Object(f.c)(e),i.field.name=a,i.field.alias=n,i}return Object(s.a)(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:this.sqlRewritable,where:Object(h.g)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return e.attributes[this.originalField.name]}}]),r}(v),m=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e,a,n){var i;for(var s in Object(l.a)(this,r),(i=t.call(this)).field=e,i.codefield=a,i.lkp=n,i.reverseLkp={},n)i.reverseLkp[n[s]]=s;return i.sqlRewritable=!0,i}return Object(s.a)(r,[{key:"rewriteSql",value:function(e,t){var a=this.evaluateNodeToWhereClause(e.parseTree,f.a.Standardised,this.field.name,this.codefield instanceof p.WhereClause?Object(h.i)(this.codefield,f.a.Standardised):this.codefield,e.parameters);return a.indexOf(r.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:p.WhereClause.create(a,t._parent.getFieldsIndex())}}},{key:"evaluateNodeToWhereClause",value:function(e,t){var n,i,l,s,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,c=arguments.length>4?arguments[4]:void 0;switch(e.type){case"interval":return Object(h.b)(this.evaluateNodeToWhereClause(e.value,t,u,o,c),e.qualifier,e.op);case"case_expression":var d=" CASE ";"simple"===e.format&&(d+=this.evaluateNodeToWhereClause(e.operand,t,u,r.BADNESS,c));for(var f=0;f<e.clauses.length;f++)d+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[f].operand,t,u,r.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[f].value,t,u,r.BADNESS,c);return null!==e.else&&(d+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,u,r.BADNESS,c)),d+=" END ";case"param":var y=c[e.value.toLowerCase()];if("string"==typeof y)return"'"+c[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(y instanceof Date)return Object(h.d)(y,t);if(y instanceof Array){for(var p=[],_=0;_<y.length;_++)"string"==typeof y[_]?p.push("'"+y[_].toString().replace(/'/g,"''")+"'"):y[_]instanceof Date?p.push(Object(h.d)(y[_],t)):p.push(y[_].toString());return p}return y.toString();case"expr_list":i=[];var v,g=Object(a.a)(e.value);try{for(g.s();!(v=g.n()).done;){var b=v.value;i.push(this.evaluateNodeToWhereClause(b,t,u,o,c))}}catch(T){g.e(T)}finally{g.f()}return i;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,u,r.BADNESS,c)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" AND "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" OR "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NOT NULL )";case"IN":if(n=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var m,F=[],w=!0,S=Object(a.a)(e.right.value);try{for(S.s();!(m=S.n()).done;){var O=m.value;if("string"!==O.type){w=!1;break}if(void 0===this.lkp[O.value]){w=!1;break}F.push(this.lkp[O.value].toString())}}catch(T){S.e(T)}finally{S.f()}if(w)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+F.join(",")+")) "}return n=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+n.join(",")+")) "}return(s=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+s.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+s+")) ";case"NOT IN":if(n=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var k,j=[],I=!0,C=Object(a.a)(e.right.value);try{for(C.s();!(k=C.n()).done;){var D=k.value;if("string"!==D.type){I=!1;break}if(void 0===this.lkp[D.value]){I=!1;break}j.push(this.lkp[D.value].toString())}}catch(T){C.e(T)}finally{C.f()}if(I)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+j.join(",")+")) "}return n=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+n.join(",")+")) "}return(s=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+s.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+s+")) ";case"BETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+o+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+o+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return Object(h.d)(e.value,t);case"number":return e.value.toString();case"current_time":return Object(h.e)("date"===e.mode,t);case"column_ref":return u&&u.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":var R=this.evaluateNodeToWhereClause(e.args,t,u,r.BADNESS,c);return Object(h.k)(e.name,R,t)}throw new Error("Unsupported sql syntax "+e.type)}},{key:"extractValue",value:function(e){return this.codefield instanceof p.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}]),r}(v);m.BADNESS="_!!!_BAD_LKP_!!!!";var F=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e,a){var n;return Object(l.a)(this,r),(n=t.call(this)).field=e,n.sql=a,n}return Object(s.a)(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:!0,where:Object(h.g)(e,this.field.name,Object(h.i)(this.sql,f.a.Standardised),t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return this.sql.calculateValueCompiled(e)}}]),r}(v),w=function(e){Object(n.a)(r,e);var t=Object(i.a)(r);function r(e){var a;return Object(l.a)(this,r),(a=t.call(this,e))._calcFunc=null,a.declaredClass="esri.arcade.featureset.actions.Adapted",a.adaptedFields=null,a._extraFilter=null,a._extraFilter=e.extraFilter,a._parent=e.parentfeatureset,a._maxProcessing=30,a.adaptedFields=e.adaptedFields,a}return Object(s.a)(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new _.a({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=f.m.point,this.typeIdField="",this.types=null),this.fields=[];var e,t=Object(a.a)(this.adaptedFields);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.postInitialization(this,this._parent),this.fields.push(r.field)}}catch(n){t.e(n)}finally{t.f()}}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(r){return t._checkCancelled(e),t._wset=new d.a(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):Object(y.t)(this._wset)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,n){var i=this,l=[];-1!==t&&void 0===this._featureCache[t]&&l.push(t);var s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,n).then((function(){return i._getFeatures(e,t,r,n)}));for(var c=0,f=e._lastFetchedIndex;f<e._known.length&&(++c<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&l.push(e._known[f]),l.length>=s)));f++);if(0===l.length)return Object(y.t)("success");e=new d.a([],l,e._ordered,null);var h=Math.min(l.length,r);return this._parent._getFeatures(e,-1,h,n).then((function(){i._checkCancelled(n);for(var e=[],t=0;t<h;t++){var r=i._parent._featureFromCache(l[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:l[t]})}for(var s=0,c=e;s<c.length;s++){var d,f=c[s],y=[],p=Object(a.a)(i.adaptedFields);try{for(p.s();!(d=p.n()).done;){var _=d.value;y[_.field.name]=_.extractValue(f)}}catch(v){p.e(v)}finally{p.f()}i._featureCache[f.id]=new u.a({attributes:y,geometry:Object(o.a)(f.geometry)})}return"success"}))}},{key:"_fetchAndRefineFeatures",value:function(){return Object(y.s)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,n,i){var l,s=this,u=this.reformulateWithoutAdaptions(r);l=u.cannot,r=u.where;var o=!1;if(null!==n){o=!0;var c,f=[],y=Object(a.a)(this.adaptedFields);try{for(y.s();!(c=y.n()).done;){var p=c.value;if(!(p instanceof g)&&!0===n.scanForField(p.field.name)){if(!(p instanceof b)){n=null,o=!1;break}f.push({field:p.field.name,newfield:p.originalField.name})}}}catch(_){y.e(_)}finally{y.f()}n&&f.length>0&&(n=n.replaceFields(f))}return null!==r?null!==this._extraFilter&&(r=Object(h.a)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((function(){return s._parent._getFilteredSet(e,t,r,n,i)})).then((function(e){return s._checkCancelled(i),!0===l?new d.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o&&e._ordered,s._clonePageDefinition(e.pagesDefinition)):new d.a(e._candidates.slice(0),e._known.slice(0),!0===o&&e._ordered,s._clonePageDefinition(e.pagesDefinition))}))}},{key:"reformulateWithoutAdaptions",value:function(e){var t={cannot:!1,where:e};if(null!==e){var r,n=Object(a.a)(this.adaptedFields);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(!0===Object(h.h)(e,i.field.name)){var l=i.rewriteSql(e,this);if(!0!==l.rewritten){t.cannot=!0,t.where=null;break}t.where=l.where}}}catch(s){n.e(s)}finally{n.f()}}return t}},{key:"_stat",value:function(e,t,r,a,n,i,l){var s=this,u=!1,o=this.reformulateWithoutAdaptions(t);return u=o.cannot,t=o.where,o=this.reformulateWithoutAdaptions(n),u=u||o.cannot,null!==(n=o.where)?null!==this._extraFilter&&(n=Object(h.a)(this._extraFilter,n)):n=this._extraFilter,!0===u?null===n&&""===r&&null===a?this._manualStat(e,t,i,l):Object(y.t)({calculated:!1}):this._parent._stat(e,t,r,a,n,i,l).then((function(u){return!1===u.calculated?null===n&&""===r&&null===a?s._manualStat(e,t,i,l):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,n,i){if(null===this._parent)return Object(y.t)(!1);for(var l=0;l<e.length;l++){var s,u=Object(a.a)(this.adaptedFields);try{for(u.s();!(s=u.n()).done;){var o=s.value;if(e[l].toLowerCase()===o.field.name.toLowerCase()&&!(o instanceof g))return Object(y.t)(!1)}}catch(b){u.e(b)}finally{u.f()}}for(var c=[],d=0;d<t.length;d++){var f=t[d];if(null!==f.workingexpr){var p=this.reformulateWithoutAdaptions(f.workingexpr);if(p.cannot)return Object(y.t)(!1);var _=f.clone();_.workingexpr=p.where,c.push(_)}else c.push(f)}var v=this.reformulateWithoutAdaptions(i);return v.cannot?Object(y.t)(!1):(null!==(i=v.where)?null!==this._extraFilter&&(i=Object(h.a)(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,c,r,n,i))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,l){if(null===this._parent)return Object(y.s)(new Error("Should never be called"));for(var s=[],u=0;u<t.length;u++){var o=t[u];if(null!==o.workingexpr){var c=this.reformulateWithoutAdaptions(o.workingexpr);if(c.cannot)return Object(y.s)(new Error("Should never be called"));var d=o.clone();d.workingexpr=c.where,s.push(d)}else s.push(o)}var f=this.reformulateWithoutAdaptions(n);return f.cannot?Object(y.s)(new Error("Should never be called")):(null!==(n=f.where)?null!==this._extraFilter&&(n=Object(h.a)(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,s,r,a,n,i,l))}}],[{key:"findField",value:function(e,t){var r,n=Object(a.a)(e);try{for(n.s();!(r=n.n()).done;){var i=r.value;if(i.name.toLowerCase()===t.toString().toLowerCase())return i}}catch(l){n.e(l)}finally{n.f()}return null}}]),r}(c.a)},990:function(e,t,r){"use strict";var a=r(4),n=r(5),i=r(6),l=r(7),s=r(733),u=r(718),o=r(655),c=r(25),d=function(e){Object(i.a)(r,e);var t=Object(l.a)(r);function r(e){var n;return Object(a.a)(this,r),(n=t.call(this,e))._topnum=0,n.declaredClass="esri.arcade.featureset.actions.Top",n._countedin=0,n._maxProcessing=100,n._topnum=e.topnum,n._parent=e.parentfeatureset,n}return Object(n.a)(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new u.a(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):Object(c.t)(this._wset)}},{key:"_setKnownLength",value:function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);if(t===o.b.NotInFeatureSet)return t;var r=this._idstates[e];return r===o.b.InFeatureSet||r===o.b.NotInFeatureSet?r:t===o.b.InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=o.b.InFeatureSet,this._countedin++,o.b.InFeatureSet):(this._idstates[e]=o.b.NotInFeatureSet,o.b.NotInFeatureSet):o.b.Unknown}},{key:"_expandPagedSet",value:function(e,t,r,a,n){var i=this;if(null===this._parent)return Object(c.s)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var l=e._known.length;return l>0&&"GETPAGES"===e._known[l-1]&&(e._known.length=l-1),(l=e._candidates.length)>0&&"GETPAGES"===e._candidates[l-1]&&(e._candidates.length=l-1),Object(c.t)("success")}return this._parent._expandPagedSet(e,t,r,a,n).then((function(t){return i._setKnownLength(e)>i._topnum&&(e._known.length=i._topnum),i._setKnownLength(e)>=i._topnum&&(e._candidates.length=0),t}))}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));-1!==t&&void 0===this._featureCache[t]&&i.push(t);for(var s=0,o=e._lastFetchedIndex;o<e._known.length&&(++s<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[o]]&&(e._known[o]!==t&&i.push(e._known[o]),i.length>l)));o++);if(0===i.length)return Object(c.t)("success");var d=new u.a([],i,!1,null),f=Math.min(i.length,r);return this._parent._getFeatures(d,-1,f,a).then((function(){for(var e=0;e<f;e++){var t=n._parent._featureFromCache(i[e]);void 0!==t&&(n._featureCache[i[e]]=t)}return"success"}))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this._ensureLoaded().then((function(){return i._getSet(n)})).then((function(e){return new u.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_refineKnowns",value:function(e,t){for(var r=0,a=null,n=[],i=0;i<e._candidates.length;i++){var l=this._isInFeatureSet(e._candidates[i]);if(l===o.b.InFeatureSet){if(e._known.push(e._candidates[i]),r+=1,null===a?a={start:i,end:i}:a.end===i-1?a.end=i:(n.push(a),a={start:i,end:i}),e._known.length>=this._topnum)break}else if(l===o.b.NotInFeatureSet)null===a?a={start:i,end:i}:a.end===i-1?a.end=i:(n.push(a),a={start:i,end:i}),r+=1;else if(l===o.b.Unknown)break;if(r>=t)break}null!==a&&n.push(a);for(var s=n.length-1;s>=0;s--)e._candidates.splice(n[s].start,n[s].end-n[s].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}},{key:"_stat",value:function(){return Object(c.t)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(c.t)(!1)}}],[{key:"registerAction",value:function(){s.a._featuresetFunctions.top=function(e){return new r({parentfeatureset:this,topnum:e})}}}]),r}(s.a);t.a=d},991:function(e,t,r){"use strict";var a=r(15),n=r(4),i=r(5),l=r(6),s=r(7),u=r(114),o=r(733),c=r(718),d=r(655),f=r(757),h=r(25),y=r(116),p=r(270),_=r(347),v=r(240),g=r(98),b=function(e){Object(l.a)(r,e);var t=Object(s.a)(r);function r(e){var a;return Object(n.a)(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",a._removeGeometry=!1,a._overrideFields=null,a._forceIsTable=!1,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,!0===e.isTable&&(a._forceIsTable=!0),void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),a}return Object(i.a)(r,[{key:"_maxQueryRate",value:function(){return d.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(h.c)((function(t,r){if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(a){r(a)}}),r),e._layer.load()}))),this._loadPromise}},{key:"gdbVersion",get:function(){return""}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=Object(a.a)(this.fields);try{for(r.s();!(e=r.n()).done;){var n=e.value;if("oid"===n.type)t.push(n);else{var i,l=Object(a.a)(this._layer.outFields);try{for(l.s();!(i=l.n()).done;){if(i.value.toLowerCase()===n.name.toLowerCase()){t.push(n);break}}}catch(g){l.e(g)}finally{l.f()}}}}catch(g){r.e(g)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var s,u=[],o=[],c=Object(a.a)(this.fields);try{for(c.s();!(s=c.n()).done;){var f=s.value;if("oid"===f.type)u.push(f),o.push(f.name);else{var h,y=Object(a.a)(this._overrideFields);try{for(y.s();!(h=y.n()).done;){if(h.value.toLowerCase()===f.name.toLowerCase()){u.push(f),o.push(f.name);break}}}catch(g){y.e(g)}finally{y.f()}}}}catch(g){c.e(g)}finally{c.f()}this.fields=u,this._overrideFields=o}this.objectIdField=this._layer.objectIdField;var p,_=Object(a.a)(this.fields);try{for(_.s();!(p=_.n()).done;){var v=p.value;"global-id"===v.type&&(this.globalIdField=v.name)}}catch(g){_.e(g)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=d.a.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"isTable",value:function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}},{key:"_isInFeatureSet",value:function(){return d.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(h.t)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},n=Object(a.a)(this.fields);try{for(n.s();!(t=n.n()).done;){var i=t.value;r[i.name]=e.attributes[i.name]}}catch(l){n.e(l)}finally{n.f()}return new u.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this,l="",s=!1;if(null!==a&&(l=a.constructClause(),s=!0),this.isTable()&&t&&null!==e&&""!==e){var u=new c.a([],[],!0,null);return Object(h.t)(u)}var o=new g.a;return o.where=null===r?null===t?"1=1":"":Object(f.i)(r,d.a.Standardised),o.spatialRelationship=this._makeRelationshipEnum(e),o.outSpatialReference=this.spatialReference,o.orderByFields=""!==l?l.split(","):null,o.geometry=null===t?null:t,o.returnGeometry=!0,o.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(o).then((function(e){if(null===e)return new c.a([],[],s,null);i._checkCancelled(n);var t=[];return e.features.forEach((function(e){var r=e.attributes[i._layer.objectIdField];t.push(r),i._featureCache[r]=i._changeFeature(e)})),new c.a([],t,s,null)}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_queryAllFeatures",value:function(){var e=this;if(this._wset)return Object(h.t)(this._wset);var t=new g.a;return t.where="1=1",this._ensureLoaded().then((function(){if(e._layer.source&&e._layer.source.items){var r=[];return e._layer.source.items.forEach((function(t){var a=t.attributes[e._layer.objectIdField];r.push(a),e._featureCache[a]=e._changeFeature(t)})),e._wset=new c.a([],r,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(t){var r=[];return t.features.forEach((function(t){var a=t.attributes[e._layer.objectIdField];r.push(a),e._featureCache[a]=e._changeFeature(t)})),e._wset=new c.a([],r,!1,null),e._wset}))}))}},{key:"_getFeatures",value:function(e,t,r){var a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);for(var n=e._lastFetchedIndex;n<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&a.push(e._known[n]),a.length>r)));n++);return 0===a.length?Object(h.t)("success"):Object(h.s)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e){return Object(h.t)(e)}},{key:"_stat",value:function(){return Object(h.t)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(h.t)(!1)}},{key:"relationshipMetaData",value:function(){return[]}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}},{key:"queryAttachments",value:function(){return Object(h.t)([])}},{key:"getFeatureByObjectId",value:function(e){var t=new g.a;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getOwningSystemUrl",value:function(){return Object(h.t)("")}},{key:"getIdentityUser",value:function(){return Object(h.t)("")}}],[{key:"_cloneAttr",value:function(e){var t={};for(var r in e)t[r]=e[r];return t}},{key:"create",value:function(e,t){var n=e.layerDefinition.objectIdField,i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",l=[];if(e.layerDefinition.types){var s,u=Object(a.a)(e.layerDefinition.types);try{for(u.s();!(s=u.n()).done;){var o=s.value;l.push(_.a.fromJSON(o))}}catch(q){u.e(q)}finally{u.f()}}var c=e.layerDefinition.geometryType;void 0===c&&(c=e.featureSet.geometryType||"");var d=e.featureSet.features,f=t.toJSON();if(""===n||void 0===n){var h,g=!1,b=Object(a.a)(e.layerDefinition.fields);try{for(b.s();!(h=b.n()).done;){var m=h.value;if("oid"===m.type||"esriFieldTypeOID"===m.type){n=m.name,g=!0;break}}}catch(q){b.e(q)}finally{b.f()}if(!1===g){for(var F="FID",w=!0,S=0;w;){var O,k=!0,j=Object(a.a)(e.layerDefinition.fields);try{for(j.s();!(O=j.n()).done;){if(O.value.name===F){k=!1;break}}}catch(q){j.e(q)}finally{j.f()}!0===k?w=!1:F="FID"+(++S).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:F,alias:F});for(var I=[],C=0;C<d.length;C++)I.push({geometry:e.featureSet.features[C].geometry,attributes:e.featureSet.features[C].attributes?this._cloneAttr(e.featureSet.features[C].attributes):{}}),I[C].attributes[F]=C;d=I,n=F}}var D,R=[],T=Object(a.a)(e.layerDefinition.fields);try{for(T.s();!(D=T.n()).done;){var x=D.value;x instanceof v.a?R.push(x):R.push(v.a.fromJSON(x))}}catch(q){T.e(q)}finally{T.f()}var N=c;switch(N){case"esriGeometryPoint":N="point";break;case"esriGeometryPolyline":N="polyline";break;case"esriGeometryPolygon":N="polygon";break;case"esriGeometryExtent":N="extent";break;case"esriGeometryMultipoint":N="multipoint"}var E,P=Object(a.a)(d);try{for(P.s();!(E=P.n()).done;){var A=E.value;A.geometry&&A.geometry instanceof y.a==0&&(A.geometry.type=N,void 0===A.geometry.spatialReference&&(A.geometry.spatialReference=f))}}catch(q){P.e(q)}finally{P.f()}var L={outFields:["*"],source:d,fields:R,types:l,typeIdField:i,objectIdField:n,spatialReference:t};return L.geometryType=N||"point",new r({layer:new p.default(L),spatialReference:t,isTable:null===N||""===N})}}]),r}(o.a);t.a=b}}]);
//# sourceMappingURL=26.676c6be9.chunk.js.map